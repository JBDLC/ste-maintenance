{% extends "base.html" %}

{% block title %}Nouvelle Commande{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-plus text-primary"></i> Nouvelle Commande
        </h1>
        <a href="{{ url_for('commandes') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Retour aux commandes
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-shopping-cart"></i> Formulaire de commande
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        <div class="row">
                            <!-- Site -->
                            <div class="col-md-6 mb-3">
                                <label for="site_id" class="form-label">
                                    <i class="fas fa-building text-primary"></i> Site <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="site_id" name="site_id" required>
                                    <option value="">Sélectionner un site...</option>
                                    {% for site in sites %}
                                    <option value="{{ site.id }}">{{ site.nom }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Sélectionnez le site concerné</div>
                            </div>

                            <!-- Localisation -->
                            <div class="col-md-6 mb-3">
                                <label for="localisation_id" class="form-label">
                                    <i class="fas fa-map-marker-alt text-primary"></i> Localisation <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="localisation_id" name="localisation_id" required disabled>
                                    <option value="">Sélectionner d'abord un site...</option>
                                </select>
                                <div class="form-text">Sélectionnez la localisation dans le site</div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Équipement -->
                            <div class="col-md-6 mb-3">
                                <label for="equipement_id" class="form-label">
                                    <i class="fas fa-cogs text-primary"></i> Équipement <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="equipement_id" name="equipement_id" required disabled>
                                    <option value="">Sélectionner d'abord une localisation...</option>
                                </select>
                                <div class="form-text">Sélectionnez l'équipement concerné</div>
                            </div>

                            <!-- Pièce de rechange -->
                            <div class="col-md-6 mb-3">
                                <label for="piece_id" class="form-label">
                                    <i class="fas fa-boxes text-primary"></i> Pièce de rechange
                                </label>
                                <select class="form-select" id="piece_id" name="piece_id" disabled>
                                    <option value="">Sélectionner d'abord un équipement...</option>
                                </select>
                                <div class="form-text">Sélectionnez une pièce de rechange disponible (optionnel)</div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Prix -->
                            <div class="col-md-6 mb-3">
                                <label for="prix" class="form-label">
                                    <i class="fas fa-euro-sign text-primary"></i> Prix <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="prix" name="prix" 
                                           step="0.01" min="0" required placeholder="0.00">
                                    <span class="input-group-text">€</span>
                                </div>
                                <div class="form-text">Prix estimé de la commande</div>
                            </div>

                            <!-- Imputation -->
                            <div class="col-md-6 mb-3">
                                <label for="imputation" class="form-label">
                                    <i class="fas fa-tag text-primary"></i> Imputation
                                </label>
                                <input type="text" class="form-control" id="imputation" name="imputation" 
                                       value="8I7315M" readonly>
                                <div class="form-text">Code d'imputation budgétaire</div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Pièce jointe -->
                            <div class="col-md-6 mb-3">
                                <label for="piece_jointe" class="form-label">
                                    <i class="fas fa-paperclip text-primary"></i> Pièce jointe
                                </label>
                                <input type="file" class="form-control" id="piece_jointe" name="piece_jointe" 
                                       accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
                                <div class="form-text">Devis, catalogue, photo... (optionnel)</div>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            <label for="description" class="form-label">
                                <i class="fas fa-align-left text-primary"></i> Description
                            </label>
                            <textarea class="form-control" id="description" name="description" rows="4" 
                                      placeholder="Décrivez le besoin, la raison de la commande, les spécifications techniques..."></textarea>
                            <div class="form-text">Description détaillée de la commande (optionnel)</div>
                        </div>

                        <!-- Boutons d'action -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('commandes') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Annuler
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Créer la commande
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Panneau d'aide -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-info-circle text-info"></i> Aide
                    </h6>
                </div>
                <div class="card-body">
                    <h6>Comment créer une commande ?</h6>
                    <ol class="small">
                        <li>Sélectionnez le <strong>site</strong> concerné</li>
                        <li>Choisissez la <strong>localisation</strong> dans ce site</li>
                        <li>Sélectionnez l'<strong>équipement</strong> concerné</li>
                        <li>Indiquez le <strong>prix estimé</strong></li>
                        <li>Ajoutez une <strong>description</strong> si nécessaire</li>
                        <li>Joignez un <strong>fichier</strong> (devis, photo...)</li>
                    </ol>
                    
                    <hr>
                    
                    <h6>Informations importantes</h6>
                    <ul class="small">
                        <li>L'<strong>imputation</strong> est automatiquement définie à <code>8I7315M</code></li>
                        <li>Un <strong>email de notification</strong> sera envoyé automatiquement</li>
                        <li>La commande sera visible dans la liste des commandes</li>
                        <li>Vous pourrez la modifier ou la supprimer ultérieurement</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript pour la sélection en cascade -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const siteSelect = document.getElementById('site_id');
    const localisationSelect = document.getElementById('localisation_id');
    const equipementSelect = document.getElementById('equipement_id');
    const pieceSelect = document.getElementById('piece_id'); // Nouvelle sélection

    // Fonction pour réinitialiser les sélections dépendantes
    function resetDependentSelects(select, message) {
        select.innerHTML = `<option value="">${message}</option>`;
        select.disabled = true;
        select.value = '';
    }

    // Gestionnaire pour le changement de site
    siteSelect.addEventListener('change', function() {
        const siteId = this.value;
        
        if (siteId) {
            // Réinitialiser les sélections dépendantes
            resetDependentSelects(localisationSelect, 'Chargement des localisations...');
            resetDependentSelects(equipementSelect, 'Sélectionner d\'abord une localisation...');
            resetDependentSelects(pieceSelect, 'Sélectionner d\'abord un équipement...'); // Réinitialiser la pièce
            
            // Charger les localisations du site
            fetch(`/api/site/${siteId}/localisations`)
                .then(response => response.json())
                .then(data => {
                    localisationSelect.innerHTML = '<option value="">Sélectionner une localisation...</option>';
                    data.forEach(loc => {
                        const option = document.createElement('option');
                        option.value = loc.id;
                        option.textContent = loc.nom;
                        localisationSelect.appendChild(option);
                    });
                    localisationSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des localisations:', error);
                    resetDependentSelects(localisationSelect, 'Erreur de chargement');
                });
        } else {
            resetDependentSelects(localisationSelect, 'Sélectionner d\'abord un site...');
            resetDependentSelects(equipementSelect, 'Sélectionner d\'abord une localisation...');
            resetDependentSelects(pieceSelect, 'Sélectionner d\'abord un équipement...'); // Réinitialiser la pièce
        }
    });

    // Gestionnaire pour le changement de localisation
    localisationSelect.addEventListener('change', function() {
        const localisationId = this.value;
        
        if (localisationId) {
            // Réinitialiser la sélection d'équipement
            resetDependentSelects(equipementSelect, 'Chargement des équipements...');
            resetDependentSelects(pieceSelect, 'Sélectionner d\'abord un équipement...'); // Réinitialiser la pièce
            
            // Charger les équipements de la localisation
            fetch(`/api/localisation/${localisationId}/equipements`)
                .then(response => response.json())
                .then(data => {
                    equipementSelect.innerHTML = '<option value="">Sélectionner un équipement...</option>';
                    data.forEach(equip => {
                        const option = document.createElement('option');
                        option.value = equip.id;
                        option.textContent = equip.nom;
                        if (equip.description) {
                            option.textContent += ` - ${equip.description}`;
                        }
                        equipementSelect.appendChild(option);
                    });
                    equipementSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des équipements:', error);
                    resetDependentSelects(equipementSelect, 'Erreur de chargement');
                });
        } else {
            resetDependentSelects(equipementSelect, 'Sélectionner d\'abord une localisation...');
            resetDependentSelects(pieceSelect, 'Sélectionner d\'abord un équipement...'); // Réinitialiser la pièce
        }
    });

    // Gestionnaire pour le changement d'équipement
    equipementSelect.addEventListener('change', function() {
        const equipementId = this.value;
        
        if (equipementId) {
            // Réinitialiser la sélection de la pièce
            resetDependentSelects(pieceSelect, 'Chargement des pièces de rechange...');
            
            // Charger les pièces de rechange de l'équipement
            fetch(`/api/equipement/${equipementId}/pieces`)
                .then(response => response.json())
                .then(data => {
                    pieceSelect.innerHTML = '<option value="">Sélectionner une pièce de rechange...</option>';
                                         data.forEach(piece => {
                         const option = document.createElement('option');
                         option.value = piece.id;
                         option.textContent = piece.item || `Pièce #${piece.id}`;
                         if (piece.quantite_stock !== undefined) {
                             option.textContent += ` (Stock: ${piece.quantite_stock})`;
                         }
                         pieceSelect.appendChild(option);
                     });
                    pieceSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des pièces de rechange:', error);
                    resetDependentSelects(pieceSelect, 'Erreur de chargement');
                });
        } else {
            resetDependentSelects(pieceSelect, 'Sélectionner d\'abord un équipement...');
        }
    });

    // Validation du formulaire
    document.querySelector('form').addEventListener('submit', function(e) {
        const siteId = siteSelect.value;
        const localisationId = localisationSelect.value;
        const equipementId = equipementSelect.value;
        const pieceId = pieceSelect.value; // Ajouter la validation de la pièce
        const prix = document.getElementById('prix').value;

        if (!siteId || !localisationId || !equipementId || !prix) {
            e.preventDefault();
            alert('Veuillez remplir tous les champs obligatoires (marqués d\'un *)');
            return false;
        }

        if (parseFloat(prix) <= 0) {
            e.preventDefault();
            alert('Le prix doit être supérieur à 0');
            return false;
        }
    });
});
</script>
{% endblock %}




