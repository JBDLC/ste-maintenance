{% extends "base.html" %}

{% block title %}Paramètres - Gestion Maintenance Préventive{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Paramètres</h1>
    <div class="btn-group" role="group">
        <a href="{{ url_for('gestion_utilisateurs') }}" class="btn btn-outline-primary">
            <i class="fas fa-users"></i> Gestion Utilisateurs
        </a>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-envelope"></i> Configuration Email</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="email_rapport" class="form-label">Adresse email de réception</label>
                        <input type="email" class="form-control" id="email_rapport" name="email_rapport" value="{{ email_rapport }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="smtp_server" class="form-label">Serveur SMTP</label>
                        <input type="text" class="form-control" id="smtp_server" name="smtp_server" value="{{ smtp_server }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="smtp_port" class="form-label">Port SMTP</label>
                        <input type="number" class="form-control" id="smtp_port" name="smtp_port" value="{{ smtp_port or 587 }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="smtp_user" class="form-label">Nom d'utilisateur SMTP</label>
                        <input type="text" class="form-control" id="smtp_user" name="smtp_user" value="{{ smtp_user }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="smtp_password" class="form-label">Mot de passe SMTP</label>
                        <input type="password" class="form-control" id="smtp_password" name="smtp_password" value="{{ smtp_password }}" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Sauvegarder</button>
                    <button type="submit" formaction="{{ url_for('test_email') }}" formmethod="post" class="btn btn-info ms-2">Test</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6 mt-4 mt-md-0">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-database"></i> Taille des données en temps réel</h5>
            </div>
            <div class="card-body">
                <div id="taille-tables-loading">Chargement...</div>
                <div id="taille-fichier" class="mb-2 d-none"></div>
                <table class="table table-sm d-none" id="taille-tables-table" style="font-size: 70%;">
                    <thead><tr><th>Table</th><th>Nombre de lignes</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    fetch('/parametres/taille-tables')
        .then(r => r.json())
        .then(data => {
            const table = document.getElementById('taille-tables-table');
            const loading = document.getElementById('taille-tables-loading');
            const tailleFichier = document.getElementById('taille-fichier');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            let totalLignes = 0;
            for (const [nom, nb] of Object.entries(data.lignes)) {
                totalLignes += nb;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${nom}</td><td>${nb}</td>`;
                tbody.appendChild(tr);
            }
            const trTotal = document.createElement('tr');
            trTotal.innerHTML = `<th>Total</th><th>${totalLignes}</th>`;
            tbody.appendChild(trTotal);
            // Affichage taille fichier
            tailleFichier.textContent = `Taille totale du fichier .db : ${(data.taille_fichier/1024).toFixed(2)} Ko`;
            tailleFichier.classList.remove('d-none');
            loading.classList.add('d-none');
            table.classList.remove('d-none');
        })
        .catch(() => {
            document.getElementById('taille-tables-loading').textContent = 'Erreur lors du chargement.';
        });
});
</script>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header bg-light"><strong>Import/Export Données</strong></div>
            <div class="card-body">
                {% for entite in ['site', 'localisation', 'equipement', 'lieu_stockage', 'piece', 'maintenance'] %}
                <div class="mb-4 border-bottom pb-3">
                    <h5 class="mb-3 text-capitalize">{{ entite.replace('_', ' ') }}s</h5>
                    <div class="d-flex flex-wrap gap-2 mb-2">
                        <a href="{{ url_for('download_modele', entite=entite, format='xlsx') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-download"></i> Modèle Excel
                        </a>
                        <a href="{{ url_for('download_modele', entite=entite, format='csv') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-download"></i> Modèle CSV
                        </a>
                        <a href="{{ url_for('export_donnees', entite=entite, format='xlsx') }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-file-excel"></i> Exporter Excel
                        </a>
                        <a href="{{ url_for('export_donnees', entite=entite, format='csv') }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-file-csv"></i> Exporter CSV
                        </a>
                    </div>
                    <form action="{{ url_for('import_donnees', entite=entite) }}" method="post" enctype="multipart/form-data" class="d-flex flex-wrap gap-2 align-items-center mb-2">
                        <input type="file" name="fichier" accept=".xlsx,.csv" class="form-control form-control-sm w-auto" required>
                        <button type="submit" class="btn btn-success btn-sm">
                            <i class="fas fa-upload"></i> Importer / Mettre à jour
                        </button>
                    </form>
                    {% if entite == 'localisation' %}
                        {# Tableau de correspondance supprimé #}
                    {% elif entite == 'equipement' %}
                        {# Tableau de correspondance supprimé #}
                    {% elif entite == 'piece' %}
                        {# Tableau de correspondance supprimé #}
                    {% elif entite == 'maintenance' %}
                        {# Tableau de correspondance supprimé #}
                    {% endif %}
                </div>
                {% endfor %}
                
                <!-- Section spéciale pour l'import des maintenances -->
                <div class="mb-4 border-bottom pb-3">
                    <h5 class="mb-3 text-success">
                        <i class="fas fa-tools"></i> Import spécial - Maintenances
                    </h5>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Import intelligent :</strong> Utilisez ce modèle pour importer des maintenances. 
                        Vous n'avez besoin que du nom de l'équipement - la localisation est automatiquement détectée.
                        <br><strong>Fonctionnalités intelligentes :</strong>
                        <ul class="mb-0 mt-2">
                            <li>Recherche automatique d'équipements similaires si le nom exact n'existe pas</li>
                            <li>Création automatique d'équipements si aucun équipement similaire n'est trouvé</li>
                            <li>Import partiel : les lignes valides sont traitées même s'il y a des erreurs</li>
                        </ul>
                    </div>
                    <div class="d-flex flex-wrap gap-2 mb-2">
                        <a href="{{ url_for('download_modele_maintenances') }}" class="btn btn-success btn-sm">
                            <i class="fas fa-download"></i> Modèle Excel Maintenances
                        </a>
                        <a href="{{ url_for('export_maintenances_special') }}" class="btn btn-info btn-sm">
                            <i class="fas fa-file-excel"></i> Exporter Maintenances (Format spécial)
                        </a>
                    </div>
                    <form action="{{ url_for('import_maintenances') }}" method="post" enctype="multipart/form-data" class="d-flex flex-wrap gap-2 align-items-center mb-2">
                        <input type="file" name="fichier" accept=".xlsx" class="form-control form-control-sm w-auto" required>
                        <button type="submit" class="btn btn-success btn-sm">
                            <i class="fas fa-upload"></i> Importer Maintenances
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modale pour gérer les équipements non trouvés -->
<div class="modal fade" id="equipementNonTrouveModal" tabindex="-1" aria-labelledby="equipementNonTrouveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="equipementNonTrouveModalLabel">
                    <i class="fas fa-question-circle text-warning"></i> Équipement non trouvé
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="equipementNonTrouveContent">
                    <!-- Le contenu sera rempli dynamiquement -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="btn btn-danger" id="btnSupprimerLigne">
                    <i class="fas fa-trash"></i> Supprimer la ligne
                </button>
                <button type="button" class="btn btn-success" id="btnCreerEquipement">
                    <i class="fas fa-plus"></i> Créer l'équipement
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales pour gérer les équipements non trouvés
let equipementsNonTrouves = [];
let currentEquipementIndex = 0;
let importData = null;

// Fonction pour gérer l'import interactif
function handleInteractiveImport(formData) {
    fetch('/parametres/import-maintenances-interactive', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.equipements_non_trouves && data.equipements_non_trouves.length > 0) {
            equipementsNonTrouves = data.equipements_non_trouves;
            importData = data.import_data;
            currentEquipementIndex = 0;
            showNextEquipement();
        } else {
            // Aucun équipement non trouvé, import direct
            handleDirectImport(formData);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de l\'import');
    });
}

// Afficher le prochain équipement non trouvé
function showNextEquipement() {
    if (currentEquipementIndex >= equipementsNonTrouves.length) {
        // Tous les équipements traités, finaliser l'import
        finalizeImport();
        return;
    }
    
    const equipement = equipementsNonTrouves[currentEquipementIndex];
    const content = document.getElementById('equipementNonTrouveContent');
    
    content.innerHTML = `
        <div class="alert alert-warning">
            <h6><i class="fas fa-exclamation-triangle"></i> Équipement non trouvé</h6>
            <p><strong>Nom de l'équipement :</strong> ${equipement.nom}</p>
            <p><strong>Ligne dans le fichier :</strong> ${equipement.ligne}</p>
            <p><strong>Maintenance associée :</strong> ${equipement.maintenance}</p>
        </div>
        
        <div class="mb-3">
            <h6>Suggestions d'équipements similaires :</h6>
            <div class="list-group">
                ${equipement.suggestions.map(s => `
                    <button type="button" class="list-group-item list-group-item-action" 
                            onclick="selectSimilarEquipement('${s.nom}', '${s.localisation}')">
                        <strong>${s.nom}</strong> (${s.localisation})
                    </button>
                `).join('')}
            </div>
        </div>
        
        <div class="mb-3" id="creationSection" style="display: none;">
            <h6>Créer un nouvel équipement :</h6>
            <div class="mb-2">
                <label for="localisationSelect" class="form-label">Localisation :</label>
                <select class="form-select" id="localisationSelect">
                    <option value="">Sélectionner une localisation</option>
                    ${equipement.localisations.map(l => `
                        <option value="${l.id}">${l.nom} (${l.site})</option>
                    `).join('')}
                </select>
            </div>
        </div>
    `;
    
    // Configurer les boutons
    document.getElementById('btnSupprimerLigne').onclick = () => {
        equipement.action = 'supprimer';
        currentEquipementIndex++;
        showNextEquipement();
    };
    
    document.getElementById('btnCreerEquipement').onclick = () => {
        const localisationId = document.getElementById('localisationSelect').value;
        if (!localisationId) {
            alert('Veuillez sélectionner une localisation');
            return;
        }
        equipement.action = 'creer';
        equipement.localisation_id = localisationId;
        currentEquipementIndex++;
        showNextEquipement();
    };
    
    // Afficher la modale
    const modal = new bootstrap.Modal(document.getElementById('equipementNonTrouveModal'));
    modal.show();
}

// Sélectionner un équipement similaire
function selectSimilarEquipement(nom, localisation) {
    const equipement = equipementsNonTrouves[currentEquipementIndex];
    equipement.action = 'utiliser_similaire';
    equipement.equipement_similaire = nom;
    currentEquipementIndex++;
    showNextEquipement();
}

// Finaliser l'import avec les décisions
function finalizeImport() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('equipementNonTrouveModal'));
    modal.hide();
    
    // Envoyer les décisions au serveur
    fetch('/parametres/import-maintenances-finalize', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            import_data: importData,
            decisions: equipementsNonTrouves
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erreur lors de l\'import final : ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de l\'import final');
    });
}

// Import direct (sans équipements non trouvés)
function handleDirectImport(formData) {
    fetch('/parametres/import-maintenances', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Erreur lors de l\'import');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de l\'import');
    });
}

// Intercepter le formulaire d'import
document.addEventListener('DOMContentLoaded', function() {
    const importForm = document.querySelector('form[action*="import-maintenances"]');
    if (importForm) {
        importForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            handleInteractiveImport(formData);
        });
    }
});
</script>
{% endblock %} 